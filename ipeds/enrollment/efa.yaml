inherits: ["db.yaml"]

global:
  zip:
    target_name: ef201Xa_rv.csv
  seperator: ","
  name: ipeds
  use_schema: True
  encoding: utf-8-sig
  strip_column_whitespace: True
  na_values: ['']
  source_vars:
    year: [2012, 2013, 2014, 2015]
  type:
    UNITID: str
    CIPCODE: str
  source : "data/ipeds/enrollment/enrollment/efa/ef<year>a.zip"
  output : "data/output/ipeds/enrollment/efa/ef<year>a"

  web_paths: "https://nces.ed.gov/ipeds/datacenter/data/EF<year>A.zip"

  add_pks: True

  db_settings:
    type:
      university: text
      cip: text
      num_enrolled: float

  rename:
    UNITID: university
    EFALEVEL: efalevel
    LINE: line
    LSTUDY: lstudy
    SECTION: enrollment_status
    EFTOTLT: enrolled_total
    EFTOTLM: enrolled_men_total
    EFTOTLW: enrolled_women_total
    EFAIANT: enrolled_native_total
    EFAIANM: enrolled_native_men
    EFAIANW: enrolled_native_women
    EFASIAT: enrolled_asian_total
    EFASIAM: enrolled_asian_men
    EFASIAW: enrolled_asian_women
    EFBKAAT: enrolled_black_total
    EFBKAAM: enrolled_black_men
    EFBKAAW: enrolled_black_women
    EFHISPT: enrolled_hispanic_total
    EFHISPM: enrolled_hispanic_men
    EFHISPW: enrolled_hispanic_women
    EFNHPIT: enrolled_hawaiian_total
    EFNHPIM: enrolled_hawaiian_men
    EFNHPIW: enrolled_hawaiian_women
    EFWHITT: enrolled_white_total
    EFWHITM: enrolled_white_men
    EFWHITW: enrolled_white_women
    EF2MORT: enrolled_multiracial_total
    EF2MORM: enrolled_multiracial_men
    EF2MORW: enrolled_multiracial_women
    EFUNKNT: enrolled_unknown_total
    EFUNKNM: enrolled_unknown_men
    EFUNKNW: enrolled_unknown_women
    EFNRALT: enrolled_nonresident_total
    EFNRALM: enrolled_nonresident_men
    EFNRALW: enrolled_nonresident_women

  regex_drop:
    "^X<anything>": "delete"


  transform:
    - type: filter
      column: efalevel
      func: isin
      value: [22, 32, 42, 52]
      negate: True
    - type: drop
      column: [efalevel, line]
    - type: plugin
      func: ipeds.plugins.enrollment.transform_race_gender
      pk: [year, university, lstudy, enrollment_status]
      raw_mode: True


tables:
  enrollment_efa_yu:
    pk: [year, university]
    agg: sum
    post_agg_transform:
      - type: drop
        column: [lstudy, enrollment_status, sex, ipeds_race]
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: [year, university]
        raw_mode: True
        default_agg: median



  enrollment_efa_ys:
    pk: ['year', 'sex']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['ipeds_race', 'enrollment_status', 'lstudy', 'university']


  enrollment_efa_yr:
    pk: ['year', 'ipeds_race']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'enrollment_status', 'lstudy', 'university']


  enrollment_efa_yl:
    pk: ['year', 'lstudy']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'ipeds_race', 'enrollment_status', 'university']


  enrollment_efa_ye:
    pk: ['year', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'ipeds_race', 'lstudy', 'university']


  enrollment_efa_ysr:
    pk: ['year', 'sex', 'ipeds_race']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['enrollment_status', 'lstudy', 'university']


  enrollment_efa_ysl:
    pk: ['year', 'sex', 'lstudy']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['ipeds_race', 'enrollment_status', 'university']


  enrollment_efa_yse:
    pk: ['year', 'sex', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['ipeds_race', 'lstudy', 'university']


  enrollment_efa_yrl:
    pk: ['year', 'ipeds_race', 'lstudy']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'enrollment_status', 'university']


  enrollment_efa_yre:
    pk: ['year', 'ipeds_race', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'lstudy', 'university']


  enrollment_efa_yle:
    pk: ['year', 'lstudy', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'ipeds_race', 'university']


  enrollment_efa_ysrl:
    pk: ['year', 'sex', 'ipeds_race', 'lstudy']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['enrollment_status', 'university']


  enrollment_efa_ysre:
    pk: ['year', 'sex', 'ipeds_race', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['lstudy', 'university']


  enrollment_efa_ysle:
    pk: ['year', 'sex', 'lstudy', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['ipeds_race', 'university']


  enrollment_efa_yrle:
    pk: ['year', 'ipeds_race', 'lstudy', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'university']


  enrollment_efa_ysrle:
    pk: ['year', 'sex', 'ipeds_race', 'lstudy', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['university']




  enrollment_efa_yus:
    pk: ['year', 'university', 'sex']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['ipeds_race', 'enrollment_status', 'lstudy']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'sex']
        raw_mode: True
        default_agg: median


  enrollment_efa_yur:
    pk: ['year', 'university', 'ipeds_race']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'enrollment_status', 'lstudy']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'ipeds_race']
        raw_mode: True
        default_agg: median


  enrollment_efa_yul:
    pk: ['year', 'university', 'lstudy']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'ipeds_race', 'enrollment_status']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'lstudy']
        raw_mode: True
        default_agg: median


  enrollment_efa_yue:
    pk: ['year', 'university', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'ipeds_race', 'lstudy']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'enrollment_status']
        raw_mode: True
        default_agg: median


  enrollment_efa_yusr:
    pk: ['year', 'university', 'sex', 'ipeds_race']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['enrollment_status', 'lstudy']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'sex', 'ipeds_race']
        raw_mode: True
        default_agg: median


  enrollment_efa_yusl:
    pk: ['year', 'university', 'sex', 'lstudy']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['ipeds_race', 'enrollment_status']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'sex', 'lstudy']
        raw_mode: True
        default_agg: median


  enrollment_efa_yuse:
    pk: ['year', 'university', 'sex', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['ipeds_race', 'lstudy']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'sex', 'enrollment_status']
        raw_mode: True
        default_agg: median


  enrollment_efa_yurl:
    pk: ['year', 'university', 'ipeds_race', 'lstudy']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'enrollment_status']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'ipeds_race', 'lstudy']
        raw_mode: True
        default_agg: median


  enrollment_efa_yure:
    pk: ['year', 'university', 'ipeds_race', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'lstudy']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'ipeds_race', 'enrollment_status']
        raw_mode: True
        default_agg: median


  enrollment_efa_yule:
    pk: ['year', 'university', 'lstudy', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex', 'ipeds_race']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'lstudy', 'enrollment_status']
        raw_mode: True
        default_agg: median


  enrollment_efa_yusrl:
    pk: ['year', 'university', 'sex', 'ipeds_race', 'lstudy']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['enrollment_status']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'sex', 'ipeds_race', 'lstudy']
        raw_mode: True
        default_agg: median


  enrollment_efa_yusre:
    pk: ['year', 'university', 'sex', 'ipeds_race', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['lstudy']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'sex', 'ipeds_race', 'enrollment_status']
        raw_mode: True
        default_agg: median


  enrollment_efa_yusle:
    pk: ['year', 'university', 'sex', 'lstudy', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['ipeds_race']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'sex', 'lstudy', 'enrollment_status']
        raw_mode: True
        default_agg: median


  enrollment_efa_yurle:
    pk: ['year', 'university', 'ipeds_race', 'lstudy', 'enrollment_status']
    agg: sum
    post_agg_transform:
      - type: drop
        column: ['sex']
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: ['year', 'university', 'ipeds_race', 'lstudy', 'enrollment_status']
        raw_mode: True
        default_agg: median


  # CORE TABLE
  enrollment_efa_yusrle:
    pk: [year, university, sex, ipeds_race, lstudy, enrollment_status]

    post_agg_transform:
      - type: plugin
        func: ipeds.plugins.carnegie.add_rows
        pk: [year, university, sex, ipeds_race, lstudy, enrollment_status]
        raw_mode: True
        default_agg: median
